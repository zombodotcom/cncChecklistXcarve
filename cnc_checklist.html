<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Carve CNC Pre-Flight Checklist</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #F59E0B;
            --primary-hover: #D97706;
            --primary-glow: rgba(245, 158, 11, 0.35);
            --accent: #0EA5E9;
            --success: #10B981;
            --success-soft: rgba(16, 185, 129, 0.15);
            --warning: #FBBF24;
            --warning-text: #1C1917;
            --danger: #DC2626;
            --danger-glow: rgba(220, 38, 38, 0.4);
            --bg: #1C1917;
            --bg-elevated: #292524;
            --bg-card: #44403C;
            --bg-hover: #57534E;
            --border: #57534E;
            --border-focus: #78716C;
            --text: #FAFAF9;
            --text-muted: #A8A29E;
            --radius: 10px;
            --radius-sm: 6px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.35);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', system-ui, sans-serif;
            background: var(--bg);
            background-image: radial-gradient(ellipse 120% 80% at 50% -20%, rgba(245, 158, 11, 0.08), transparent),
                              radial-gradient(ellipse 80% 50% at 100% 50%, rgba(14, 165, 233, 0.04), transparent);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            background: linear-gradient(145deg, var(--bg-elevated) 0%, var(--bg-card) 100%);
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            padding: 28px 32px;
            border-radius: var(--radius);
            margin-bottom: 28px;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 6px;
            color: var(--primary);
            letter-spacing: -0.02em;
        }
        
        .header .subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }
        
        .mode-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: var(--bg-elevated);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .mode-btn {
            flex: 1;
            padding: 18px 20px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.95rem;
            text-align: center;
        }
        
        .mode-btn:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }
        
        .mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg);
            box-shadow: 0 4px 16px var(--primary-glow);
        }
        
        .mode-btn small {
            display: block;
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .stats {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 180px;
            background: var(--bg-elevated);
            padding: 18px 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
            letter-spacing: -0.02em;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 600;
        }
        
        .stat-card.progress .stat-value { color: var(--primary); }
        .stat-card.time .stat-value { color: var(--success); }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-hover) 100%);
            transition: width 0.4s ease;
            border-radius: 4px;
        }
        
        .section {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 22px 24px;
            margin-bottom: 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .section:hover {
            border-color: var(--border-focus);
        }
        
        .section.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--success-soft) 100%);
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.2);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
            margin-bottom: 0;
            transition: opacity 0.15s ease;
        }
        
        .section-header:hover {
            opacity: 0.9;
        }
        
        .section.collapsed .section-header {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .section-body {
            padding-top: 18px;
            overflow: hidden;
            transition: opacity 0.2s ease;
        }
        
        .section.collapsed .section-body {
            display: none;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 1.5rem;
        }
        
        .section-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }
        
        .section-chevron {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--primary);
            transition: transform 0.2s ease;
        }
        
        .section.collapsed .section-chevron {
            transform: rotate(-90deg);
        }
        
        .section-progress {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .checklist-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 4px;
            transition: background 0.15s ease;
            cursor: pointer;
        }
        
        .checklist-item:hover {
            background: var(--bg-hover);
        }
        
        .checklist-item.checked {
            opacity: 0.75;
        }
        
        .checklist-item.checked .item-text {
            text-decoration: line-through;
            color: var(--text-muted);
        }
        
        .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border);
            border-radius: 5px;
            margin-right: 14px;
            margin-top: 2px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            transition: all 0.2s ease;
        }
        
        .checklist-item.checked .checkbox {
            background: var(--success);
            border-color: var(--success);
        }
        
        .checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 13px;
            font-weight: 700;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease;
        }
        
        .checklist-item.checked .checkbox::after {
            opacity: 1;
            transform: scale(1);
        }
        
        .item-text {
            flex: 1;
            font-size: 0.98rem;
            line-height: 1.5;
        }
        
        .item-priority {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 8px;
        }
        
        .priority-critical {
            background: var(--danger);
            color: white;
        }
        
        .priority-important {
            background: var(--warning);
            color: var(--warning-text);
        }
        
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--bg);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
            box-shadow: 0 4px 16px var(--primary-glow);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(245, 158, 11, 0.08);
        }
        
        .warning-box {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--danger);
            border-radius: var(--radius-sm);
            padding: 18px 20px;
            margin: 20px 0;
        }
        
        .warning-title {
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .tip-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: var(--radius-sm);
            padding: 18px 20px;
            margin: 20px 0;
        }
        
        .tip-title {
            font-weight: 700;
            color: var(--success);
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.65rem;
            }
            
            .mode-selector {
                flex-direction: column;
            }
            
            .stats {
                flex-direction: column;
            }
        }
        
        .emergency-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: 3px solid var(--bg-elevated);
            font-weight: 800;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 6px 24px var(--danger-glow);
            transition: all 0.2s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
        }
        
        .emergency-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 32px var(--danger-glow);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-elevated);
            border: 2px solid var(--danger);
            border-radius: var(--radius);
            padding: 32px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-title {
            font-size: 1.75rem;
            color: var(--danger);
            margin-bottom: 18px;
            font-weight: 800;
        }
        
        .modal-close {
            margin-top: 18px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
        }
        
        .search-box::placeholder {
            color: var(--text-muted);
        }
        
        .control-btn {
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .control-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(245, 158, 11, 0.08);
        }
        
        .control-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg);
        }
        
        .settings-icon {
            cursor: pointer;
            padding: 10px;
            color: var(--text-muted);
            transition: color 0.2s ease;
        }
        
        .settings-icon:hover {
            color: var(--primary);
        }
        
        .checkbox-setting {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 0;
        }
        
        .checkbox-setting input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checklist-item.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è CNC PRE-FLIGHT</h1>
            <div class="subtitle">X-Carve Post-2021 ‚Ä¢ Safety First Operations</div>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="full">
                üìã Full mode<br>
                <small>10‚Äì15 min ‚Ä¢ First of day / comprehensive</small>
            </button>
            <button class="mode-btn" data-mode="quick">
                ‚ö° Quick mode<br>
                <small>3‚Äì5 min ‚Ä¢ Experienced operators</small>
            </button>
        </div>
        
        <div class="stats">
            <div class="stat-card progress">
                <div class="stat-value" id="progressPercent">0%</div>
                <div class="stat-label">Progress</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat-card time">
                <div class="stat-value" id="estimatedTime">10-15 min</div>
                <div class="stat-label">Est. Time</div>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search checklist items...">
            <button class="control-btn" onclick="collapseAll()">‚ñ≤ Collapse All</button>
            <button class="control-btn" onclick="expandAll()">‚ñº Expand All</button>
            <span class="settings-icon" onclick="showSettings()" title="Settings">‚öôÔ∏è</span>
        </div>
        
        <div id="checklist-container"></div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="resetAll()">üîÑ Reset All</button>
            <button class="btn btn-secondary" onclick="exportLog()">üì• Export Log</button>
            <button class="btn btn-secondary" onclick="printChecklist()">üñ®Ô∏è Print</button>
        </div>
    </div>
    
    <button class="emergency-btn" onclick="showEmergency()">E-STOP</button>
    
    <div class="modal" id="emergency-modal">
        <div class="modal-content">
            <h2 class="modal-title">üö® EMERGENCY STOP</h2>
            <div class="warning-box">
                <div class="warning-title">IMMEDIATE ACTIONS:</div>
                <ol style="margin-left: 20px; line-height: 2;">
                    <li><strong>PRESS E-STOP</strong> - Red button on controller</li>
                    <li><strong>TURN OFF ROUTER</strong> - Power switch</li>
                    <li><strong>STEP BACK</strong> - Move away from machine</li>
                    <li><strong>TURN OFF VACUUM</strong> - Dust collection</li>
                    <li><strong>ASSESS</strong> - Determine what happened</li>
                </ol>
            </div>
            <div style="margin-top: 20px;">
                <strong>Common Emergencies:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li><strong>Material Loose:</strong> E-stop ‚Üí Re-clamp ‚Üí Re-zero ‚Üí Restart</li>
                    <li><strong>Bit Breaks:</strong> E-stop ‚Üí Replace bit ‚Üí Re-zero Z ‚Üí Restart</li>
                    <li><strong>Lost Steps:</strong> Power off ‚Üí Check belts ‚Üí Re-home ‚Üí Restart</li>
                    <li><strong>Smoke/Fire:</strong> E-stop ‚Üí Extinguisher ‚Üí Evacuate if needed</li>
                </ul>
            </div>
            <button class="btn btn-primary modal-close" onclick="hideEmergency()">Close</button>
        </div>
    </div>
    
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2 class="modal-title">‚öôÔ∏è Settings</h2>
            <div class="checkbox-setting">
                <input type="checkbox" id="confettiEnabled" onchange="toggleConfetti()" checked>
                <label for="confettiEnabled">Enable celebration effects when sections complete</label>
            </div>
            <button class="btn btn-secondary" onclick="testConfetti()" style="margin-top: 12px;">üéâ Test Confetti</button>
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary" onclick="clearAllData()" style="color: var(--danger); border-color: var(--danger);">
                    üóëÔ∏è Clear all saved data
                </button>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">Resets checkboxes, collapsed sections, and settings. Hard reload won‚Äôt bring them back.</p>
            </div>
            <button class="btn btn-primary modal-close" onclick="hideSettings()" style="margin-top: 12px;">Close</button>
        </div>
    </div>
    
    <script>
        const checklistData = {
            quick: [
                {
                    title: "Safety First",
                    icon: "‚ö†Ô∏è",
                    items: [
                        { text: "Safety glasses / hearing protection / dust mask ON", priority: "critical" },
                        { text: "Clear workspace - no debris or obstacles" },
                        { text: "E-Stop accessible and tested" }
                    ]
                },
                {
                    title: "CAM Pre-Check",
                    icon: "üíª",
                    items: [
                        { text: "Correct project loaded in Easel", priority: "critical" },
                        { text: "Material dimensions match physical material" },
                        { text: "Bit size in file matches installed bit", priority: "critical" },
                        { text: "Toolpath previewed - no surprises" }
                    ]
                },
                {
                    title: "Material & Clamping",
                    icon: "üì¶",
                    items: [
                        { text: "Material secure - SHAKE TEST PASSED", priority: "critical" },
                        { text: "Clamps clear of toolpath - verified", priority: "important" },
                        { text: "Wasteboard clean, no debris" }
                    ]
                },
                {
                    title: "Bit & Spindle",
                    icon: "üîß",
                    items: [
                        { text: "Correct bit installed and tight", priority: "critical" },
                        { text: "Collet clean - no sawdust" },
                        { text: "Router speed dial set (typically 2-4)" }
                    ]
                },
                {
                    title: "Zeroing",
                    icon: "üìç",
                    items: [
                        { text: "X, Y, Z all show 0.000", priority: "critical" },
                        { text: "Z-PROBE REMOVED (if used)", priority: "critical" },
                        { text: "Test 'Go to Zero' - returns correctly", priority: "important" }
                    ]
                },
                {
                    title: "Final & Start",
                    icon: "üöÄ",
                    items: [
                        { text: "Dust collection connected and ON" },
                        { text: "Hand near E-stop during operation" },
                        { text: "Router turned ON - let spin up 2 seconds" },
                        { text: "Press START in Easel" },
                        { text: "WATCH FIRST 30 SECONDS - stay alert", priority: "critical" }
                    ]
                }
            ],
            full: [
                {
                    title: "Personal Safety",
                    icon: "‚ö†Ô∏è",
                    items: [
                        { text: "Safety glasses - ANSI Z87 rated", priority: "critical" },
                        { text: "Hearing protection - earplugs or earmuffs", priority: "critical" },
                        { text: "Dust mask - appropriate for material", priority: "critical" },
                        { text: "Closed-toe shoes - no sandals" },
                        { text: "Hair tied back completely" },
                        { text: "No loose clothing - sleeves secured" },
                        { text: "No jewelry - rings, watches, necklaces removed" },
                        { text: "No gloves near spindle" }
                    ]
                },
                {
                    title: "CAM & File Prep",
                    icon: "üíª",
                    items: [
                        { text: "Correct project loaded", priority: "critical" },
                        { text: "Material dimensions set in Easel - X, Y, Z match actual", priority: "important" },
                        { text: "Material type selected (affects feed rates)" },
                        { text: "Bit diameter correct - matches installed bit", priority: "critical" },
                        { text: "Cut depths verified - through-cuts = thickness + 0.01\"" },
                        { text: "Toolpath previewed - visual check", priority: "important" },
                        { text: "Feed rate reasonable for material" },
                        { text: "Clamp positions planned" }
                    ]
                },
                {
                    title: "Workspace Environment",
                    icon: "üè†",
                    items: [
                        { text: "Work area clean - no clutter" },
                        { text: "6-inch clearance maintained from router" },
                        { text: "Good lighting - can see clearly" },
                        { text: "E-stop accessible", priority: "critical" },
                        { text: "Fire extinguisher nearby" },
                        { text: "Exit path clear" },
                        { text: "Power circuit dedicated (15A min)" },
                        { text: "Not on GFCI outlet" }
                    ]
                },
                {
                    title: "Machine Inspection",
                    icon: "üîç",
                    items: [
                        { text: "Machine level and stable" },
                        { text: "Rails clean - X and Y vacuumed" },
                        { text: "Wasteboard secure" },
                        { text: "Y1 belt tension - 'guitar string test'", priority: "important" },
                        { text: "Y2 belt tension - 'guitar string test'", priority: "important" },
                        { text: "X belt tension - 'guitar string test'", priority: "important" },
                        { text: "No belt fraying - inspect visually" },
                        { text: "Belt clips tight" },
                        { text: "Gantry moves freely (power OFF)" },
                        { text: "X-carriage moves freely (power OFF)" },
                        { text: "No binding in any axis" },
                        { text: "V-wheels snug, not loose" },
                        { text: "Router secure in Z-axis mount" }
                    ]
                },
                {
                    title: "Power Up & Connect",
                    icon: "üîå",
                    items: [
                        { text: "E-stop disengaged - twist CCW until pop", priority: "critical" },
                        { text: "Power switch OFF initially" },
                        { text: "USB connected - computer to X-Controller" },
                        { text: "Computer ready - Easel loaded" },
                        { text: "Internet connected" },
                        { text: "X-Controller powered ON" },
                        { text: "Easel 'Connect' clicked" },
                        { text: "Connection confirmed - green indicator" }
                    ]
                },
                {
                    title: "Material Setup",
                    icon: "üì¶",
                    items: [
                        { text: "Material identified and safe to cut", priority: "important" },
                        { text: "Thickness measured accurately" },
                        { text: "Surface flat on wasteboard" },
                        { text: "No metal contaminants (nails, screws)" },
                        { text: "Sized correctly for work envelope" },
                        { text: "Material CANNOT MOVE - shake test", priority: "critical" },
                        { text: "4+ clamp points distributed", priority: "important" },
                        { text: "Clamps below toolpath - verified", priority: "critical" },
                        { text: "Clearance verified - jog spindle around" },
                        { text: "No overhang risk" }
                    ]
                },
                {
                    title: "Bit Installation",
                    icon: "üîß",
                    items: [
                        { text: "Correct bit type for job", priority: "important" },
                        { text: "Bit diameter matches Easel", priority: "critical" },
                        { text: "Bit inspected - sharp, no chips" },
                        { text: "Shank clean - wiped with cloth" },
                        { text: "Long enough for cut depth + 0.25\"" },
                        { text: "Router unplugged during installation", priority: "critical" },
                        { text: "Correct collet (1/4\" or 1/8\")" },
                        { text: "Inserted 3/4\" minimum into collet" },
                        { text: "Collet tightened FIRM with two wrenches", priority: "critical" },
                        { text: "No wobble - spin test" },
                        { text: "All wrenches removed", priority: "important" }
                    ]
                },
                {
                    title: "Dust Collection",
                    icon: "üí®",
                    items: [
                        { text: "Dust shoe attached to Z-axis" },
                        { text: "Hose connected to vacuum" },
                        { text: "No blockages in hose" },
                        { text: "Clearance checked - won't hit clamps" },
                        { text: "Vacuum ready and positioned" }
                    ]
                },
                {
                    title: "Homing",
                    icon: "üè†",
                    items: [
                        { text: "'Home' clicked in Easel" },
                        { text: "Z-axis homes to top" },
                        { text: "X and Y home to front-left" },
                        { text: "Completes smoothly - no errors" }
                    ]
                },
                {
                    title: "Zeroing (CRITICAL)",
                    icon: "üìç",
                    items: [
                        { text: "Jog to X/Y origin point", priority: "critical" },
                        { text: "Origin marked and understood" },
                        { text: "'Set X/Y Zero' clicked" },
                        { text: "Displays X0.000 Y0.000" },
                        { text: "Spindle jogged up for Z-probe" },
                        { text: "Z-probe magnet attached to collet" },
                        { text: "Touch plate on material surface" },
                        { text: "'Probe' clicked - successful probe" },
                        { text: "‚ö†Ô∏è Z-PROBE REMOVED - magnet AND plate ‚ö†Ô∏è", priority: "critical" },
                        { text: "‚ö†Ô∏è DOUBLE-CHECK REMOVED ‚ö†Ô∏è", priority: "critical" },
                        { text: "'Set Z Zero' confirmed - Z shows 0.000" },
                        { text: "All zeros confirmed: X0.000 Y0.000 Z0.000", priority: "critical" },
                        { text: "'Go to Zero' test - returns correctly", priority: "important" }
                    ]
                },
                {
                    title: "Final Pre-Carve Checks",
                    icon: "‚úÖ",
                    items: [
                        { text: "Jog to all four corners - verify reach" },
                        { text: "Adequate Z clearance over clamps", priority: "important" },
                        { text: "No obstacles in cutting path" },
                        { text: "Double-check clamps - still tight", priority: "critical" },
                        { text: "Double-check zeros - still 0.000", priority: "critical" },
                        { text: "Router speed dial set (2-4 for wood)" },
                        { text: "Easel 'Carve' ready with correct file" }
                    ]
                },
                {
                    title: "Start & Monitor",
                    icon: "üëÄ",
                    items: [
                        { text: "Hands clear of cutting area", priority: "critical" },
                        { text: "E-stop positioned - hand near button", priority: "critical" },
                        { text: "Shop vac ON first", priority: "important" },
                        { text: "Safety gear on - final check" },
                        { text: "Router ON - let spin up 2 seconds", priority: "important" },
                        { text: "'Start Carve' pressed" },
                        { text: "First motion observed" },
                        { text: "WATCH FIRST 60 SECONDS", priority: "critical" },
                        { text: "Chips forming properly" },
                        { text: "No unusual sounds" },
                        { text: "Material secure - not moving" },
                        { text: "Stay within 6 feet - no distractions", priority: "important" }
                    ]
                },
                {
                    title: "Post-Operation",
                    icon: "üèÅ",
                    items: [
                        { text: "Router turned OFF after completion" },
                        { text: "Wait for spindle complete stop" },
                        { text: "Dust collection OFF" },
                        { text: "Spindle raised to safe height" },
                        { text: "Clamps removed carefully" },
                        { text: "Part removed - watch sharp edges" },
                        { text: "X-Controller powered OFF" },
                        { text: "Vacuum work area and rails" },
                        { text: "Collet cleaned" },
                        { text: "Bit cleaned and stored" }
                    ]
                }
            ]
        };
        
        let currentMode = 'full';
        let checkState = {};
        let collapsedState = {};
        let confettiEnabled = true;
        let searchQuery = '';
        let previousCompletionState = {};
        let isInitialLoad = true;
        
        // Load saved state from localStorage (supports old format: flat checkState only)
        function loadState() {
            const saved = localStorage.getItem('cnc-checklist-state');
            if (saved) {
                const data = JSON.parse(saved);
                if (data && 'checks' in data && typeof data.checks === 'object') {
                    checkState = data.checks;
                    collapsedState = data.collapsed || {};
                } else {
                    checkState = data || {};
                    collapsedState = {};
                }
            }
            
            const settings = localStorage.getItem('cnc-checklist-settings');
            if (settings) {
                const settingsData = JSON.parse(settings);
                confettiEnabled = settingsData.confettiEnabled !== false;
            }
        }
        
        // Save state to localStorage
        function saveState() {
            const data = { checks: checkState, collapsed: collapsedState };
            localStorage.setItem('cnc-checklist-state', JSON.stringify(data));
        }
        
        // Save settings to localStorage
        function saveSettings() {
            const settings = { confettiEnabled };
            localStorage.setItem('cnc-checklist-settings', JSON.stringify(settings));
        }
        
        // Initialize checklist
        function initChecklist() {
            loadState();
            renderChecklist();
            updateStats();
            
            // Mark initial load complete after first render
            setTimeout(() => {
                isInitialLoad = false;
            }, 100);
            
            // Update settings UI
            document.getElementById('confettiEnabled').checked = confettiEnabled;
            
            // Mode selector buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    document.getElementById('estimatedTime').textContent = 
                        currentMode === 'quick' ? '3-5 min' : '10-15 min';
                    
                    // Reset completion tracking when switching modes
                    previousCompletionState = {};
                    isInitialLoad = true;
                    renderChecklist();
                    updateStats();
                    setTimeout(() => {
                        isInitialLoad = false;
                    }, 100);
                });
            });
            
            // Search box
            document.getElementById('searchBox').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                filterItems();
            });
        }
        
        // Filter items based on search
        function filterItems() {
            document.querySelectorAll('.checklist-item').forEach(item => {
                const text = item.querySelector('.item-text').textContent.toLowerCase();
                if (searchQuery === '' || text.includes(searchQuery)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }
        
        // Render checklist based on mode
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            
            const data = checklistData[currentMode];
            
            data.forEach((section, sectionIdx) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'section';
                
                const checkedCount = section.items.filter((item, itemIdx) => 
                    checkState[`${currentMode}-${sectionIdx}-${itemIdx}`]
                ).length;
                
                const sectionKey = `${currentMode}-${sectionIdx}`;
                const wasCompleted = previousCompletionState[sectionKey] || false;
                const isNowCompleted = checkedCount === section.items.length;
                
                // Trigger confetti if section just became complete
                if (isNowCompleted && !wasCompleted && !isInitialLoad && confettiEnabled) {
                    console.log('Section completed! Triggering confetti for:', section.title);
                    setTimeout(() => {
                        randomConfetti();
                    }, 100);
                }
                
                if (isNowCompleted) {
                    sectionEl.classList.add('completed');
                }
                
                // Store current completion state for next render
                previousCompletionState[sectionKey] = isNowCompleted;
                
                const isCollapsed = collapsedState[sectionKey];
                if (isCollapsed) {
                    sectionEl.classList.add('collapsed');
                }
                
                sectionEl.innerHTML = `
                    <div class="section-header">
                        <div class="section-title">
                            <span class="section-chevron" aria-hidden="true">‚ñº</span>
                            <span class="section-icon">${section.icon}</span>
                            ${section.title}
                        </div>
                        <div class="section-toggle">
                            <span class="section-progress">${checkedCount}/${section.items.length}</span>
                        </div>
                    </div>
                    <div class="section-body"></div>
                `;
                
                const bodyEl = sectionEl.querySelector('.section-body');
                
                section.items.forEach((item, itemIdx) => {
                    const itemEl = document.createElement('div');
                    const itemKey = `${currentMode}-${sectionIdx}-${itemIdx}`;
                    const isChecked = checkState[itemKey];
                    
                    itemEl.className = 'checklist-item' + (isChecked ? ' checked' : '');
                    itemEl.innerHTML = `
                        <div class="checkbox"></div>
                        <div class="item-text">
                            ${item.text}
                            ${item.priority ? `<span class="item-priority priority-${item.priority}">${item.priority}</span>` : ''}
                        </div>
                    `;
                    
                    itemEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const previousState = checkState[itemKey];
                        checkState[itemKey] = !checkState[itemKey];
                        saveState();
                        
                        // Check if section just became completed
                        const newCheckedCount = section.items.filter((item, idx) => 
                            checkState[`${currentMode}-${sectionIdx}-${idx}`]
                        ).length;
                        const justCompleted = !previousState && newCheckedCount === section.items.length;
                        
                        renderChecklist();
                        updateStats();
                    });
                    
                    bodyEl.appendChild(itemEl);
                });
                
                sectionEl.querySelector('.section-header').addEventListener('click', () => {
                    collapsedState[sectionKey] = !collapsedState[sectionKey];
                    saveState();
                    sectionEl.classList.toggle('collapsed', collapsedState[sectionKey]);
                });
                
                container.appendChild(sectionEl);
            });
            
            // Apply search filter if active
            if (searchQuery) {
                filterItems();
            }
            
            // Add tips based on mode
            if (currentMode === 'quick') {
                const tipBox = document.createElement('div');
                tipBox.className = 'tip-box';
                tipBox.innerHTML = `
                    <div class="tip-title">üí° Quick Mode Tips</div>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>Use this for second/third cuts in same session</li>
                        <li>Machine shouldn't have moved since last job</li>
                        <li>Same material type as previous cut</li>
                        <li>If anything feels off, switch to FULL mode</li>
                    </ul>
                `;
                container.appendChild(tipBox);
            } else {
                const warningBox = document.createElement('div');
                warningBox.className = 'warning-box';
                warningBox.innerHTML = `
                    <div class="warning-title">‚ö†Ô∏è Critical Reminders</div>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>90% of crashes = Z-probe not removed OR bad clamping</strong></li>
                        <li>Do the SHAKE TEST on material - if it moves even slightly, re-clamp</li>
                        <li>Belt tension: should feel like a bass guitar string</li>
                        <li>Never leave machine unattended during operation</li>
                    </ul>
                `;
                container.appendChild(warningBox);
            }
        }
        
        // Update statistics
        function updateStats() {
            const data = checklistData[currentMode];
            let totalItems = 0;
            let checkedItems = 0;
            
            data.forEach((section, sectionIdx) => {
                section.items.forEach((item, itemIdx) => {
                    totalItems++;
                    if (checkState[`${currentMode}-${sectionIdx}-${itemIdx}`]) {
                        checkedItems++;
                    }
                });
            });
            
            const percent = totalItems > 0 ? Math.round((checkedItems / totalItems) * 100) : 0;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';
        }
        
        // Reset all checkboxes
        function resetAll() {
            if (confirm('Reset all checkboxes? This will clear your progress.')) {
                checkState = {};
                saveState();
                renderChecklist();
                updateStats();
            }
        }
        
        // Export log
        function exportLog() {
            const data = checklistData[currentMode];
            let log = `X-CARVE CNC PRE-FLIGHT LOG\n`;
            log += `Mode: ${currentMode.toUpperCase()}\n`;
            log += `Date: ${new Date().toLocaleString()}\n`;
            log += `\n${'='.repeat(50)}\n\n`;
            
            data.forEach((section, sectionIdx) => {
                log += `${section.icon} ${section.title}\n`;
                log += `${'-'.repeat(40)}\n`;
                section.items.forEach((item, itemIdx) => {
                    const checked = checkState[`${currentMode}-${sectionIdx}-${itemIdx}`];
                    log += `[${checked ? '‚úì' : ' '}] ${item.text}\n`;
                });
                log += `\n`;
            });
            
            const blob = new Blob([log], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cnc-checklist-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
        }
        
        // Print checklist
        function printChecklist() {
            window.print();
        }
        
        // Emergency modal
        function showEmergency() {
            document.getElementById('emergency-modal').classList.add('active');
        }
        
        function hideEmergency() {
            document.getElementById('emergency-modal').classList.remove('active');
        }
        
        // Settings modal
        function showSettings() {
            document.getElementById('settings-modal').classList.add('active');
        }
        
        function hideSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }
        
        function toggleConfetti() {
            confettiEnabled = document.getElementById('confettiEnabled').checked;
            saveSettings();
        }
        
        function randomConfetti() {
            if (typeof confetti === 'undefined') {
                console.error('Confetti library not loaded');
                return;
            }
            
            const colors = ['#F59E0B', '#10B981', '#0EA5E9', '#FBBF24', '#DC2626', '#8B5CF6'];
            const effects = [
                // Classic burst
                () => {
                    confetti({
                        particleCount: 100 + Math.random() * 50,
                        spread: 60 + Math.random() * 40,
                        origin: { y: 0.6 },
                        colors: colors
                    });
                },
                // Side cannons
                () => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: colors
                    });
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: colors
                    });
                },
                // Rain from top
                () => {
                    const duration = 1500;
                    const end = Date.now() + duration;
                    (function frame() {
                        confetti({
                            particleCount: 2,
                            angle: 90,
                            spread: 45,
                            origin: { x: Math.random(), y: 0 },
                            colors: colors,
                            ticks: 200
                        });
                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());
                },
                // Fireworks
                () => {
                    confetti({
                        particleCount: 50,
                        startVelocity: 45,
                        spread: 360,
                        ticks: 60,
                        origin: { x: 0.3 + Math.random() * 0.4, y: 0.5 + Math.random() * 0.2 },
                        colors: colors
                    });
                    setTimeout(() => {
                        confetti({
                            particleCount: 50,
                            startVelocity: 45,
                            spread: 360,
                            ticks: 60,
                            origin: { x: 0.3 + Math.random() * 0.4, y: 0.5 + Math.random() * 0.2 },
                            colors: colors
                        });
                    }, 200);
                },
                // Realistic confetti with gravity
                () => {
                    const count = 100 + Math.random() * 50;
                    const defaults = {
                        origin: { y: 0.7 },
                        colors: colors
                    };
                    confetti({
                        ...defaults,
                        particleCount: Math.floor(count * 0.25),
                        spread: 26,
                        startVelocity: 55,
                    });
                    confetti({
                        ...defaults,
                        particleCount: Math.floor(count * 0.2),
                        spread: 60,
                    });
                    confetti({
                        ...defaults,
                        particleCount: Math.floor(count * 0.35),
                        spread: 100,
                        decay: 0.91,
                        scalar: 0.8
                    });
                    confetti({
                        ...defaults,
                        particleCount: Math.floor(count * 0.1),
                        spread: 120,
                        startVelocity: 25,
                        decay: 0.92,
                        scalar: 1.2
                    });
                    confetti({
                        ...defaults,
                        particleCount: Math.floor(count * 0.1),
                        spread: 120,
                        startVelocity: 45,
                    });
                }
            ];
            
            // Pick a random effect
            const randomEffect = effects[Math.floor(Math.random() * effects.length)];
            randomEffect();
        }
        
        function testConfetti() {
            randomConfetti();
        }
        
        function clearAllData() {
            if (!confirm('Clear all saved data? Checkboxes, collapsed sections, and settings will be reset.')) {
                return;
            }
            localStorage.removeItem('cnc-checklist-state');
            localStorage.removeItem('cnc-checklist-settings');
            checkState = {};
            collapsedState = {};
            previousCompletionState = {};
            isInitialLoad = true;
            confettiEnabled = true;
            document.getElementById('confettiEnabled').checked = true;
            saveSettings();
            saveState();
            renderChecklist();
            updateStats();
            hideSettings();
            setTimeout(() => {
                isInitialLoad = false;
            }, 100);
        }
        
        // Collapse/expand all
        function collapseAll() {
            const data = checklistData[currentMode];
            data.forEach((section, sectionIdx) => {
                const sectionKey = `${currentMode}-${sectionIdx}`;
                collapsedState[sectionKey] = true;
            });
            saveState();
            renderChecklist();
        }
        
        function expandAll() {
            const data = checklistData[currentMode];
            data.forEach((section, sectionIdx) => {
                const sectionKey = `${currentMode}-${sectionIdx}`;
                collapsedState[sectionKey] = false;
            });
            saveState();
            renderChecklist();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initChecklist);
    </script>
</body>
</html>
